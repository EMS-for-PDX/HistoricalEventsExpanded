#GHAZNAVIDS

give_ghaznavid_land_effect = {
	save_scope_as = ghaznavid

	title:c_ghazna.holder = {
		if = {
			limit = {
				title:c_ghazna.holder.primary_title = {
					tier >= tier_duchy
				}
			}
			title:c_ghazna.holder = {
				random_vassal = {
					primary_title = {
						if = {
							limit = {
								tier = tier_county
							}
							save_scope_as = PrimaryTitleForEffect
						}
					}
					save_scope_as = vassal_1
				}
			}
			title:c_ghazna.holder = {
				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
					add_claim_on_loss = no
				}
				scope:PrimaryTitleForEffect = {
					change_title_holder = {
						holder = title:c_ghazna.holder
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
			}
			title:c_ghazna.holder = {
				set_realm_capital = scope:PrimaryTitleForEffect
			}
		}
		if = {
			limit = {
				title:c_ghazna.holder.capital_county = title:c_ghazna
			}
			title:c_ghazna.holder = {
				random_vassal = {
					if = {
						limit = {
							NOT = {
								this = scope:vassal_1
							}
						}
						save_scope_as = vassas_2
						primary_title = {
							limit = {
								tier = tier_county
							}
							save_scope_as = PrimaryTitleForEffect
						}
					}
				}
			}
			title:c_ghazna.holder = {
				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
					add_claim_on_loss = no
				}
				scope:PrimaryTitleForEffect = {
					change_title_holder = {
						holder = title:c_ghazna.holder
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
			}
			title:c_ghazna.holder = {
				set_realm_capital = scope:PrimaryTitleForEffect
			}
		}
		if = {
			limit = {
				title:c_ghazna.holder.capital_county = title:c_ghazna
			}
			title:c_ghazna.holder = {
				random_vassal = {
					if = {
						limit = {
							NOT = {
								this = scope:vassal_2
							}
						}
						primary_title = {
							limit = {
								tier = tier_county
							}
							save_scope_as = PrimaryTitleForEffect
						}
					}
				}
			}
			title:c_ghazna.holder = {
				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
					add_claim_on_loss = no
				}
				scope:PrimaryTitleForEffect = {
					change_title_holder = {
						holder = title:c_ghazna.holder
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
			}
			title:c_ghazna.holder = {
				set_realm_capital = scope:PrimaryTitleForEffect
			}
		}
	}

	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
		add_claim_on_loss = no
	}
	title:c_ghazna = {
		change_title_holder = {
			holder = scope:ghaznavid
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change

	after = {
		if = {
			limit = {
				global_var:ghaznavidfounder = {
					is_ruler = no
				}
			}
			global_var:ghaznavidfounder = {
				give_ghaznavid_land_effect = yes
			}
		}
	}
}

spawn_ghaznavids_character_effect = {
	title:c_ghazna.title_province = {
		save_scope_as = ghaznavids_birthplace
	}
	create_character = {
		name = "Sabuktigin"
		location = scope:ghaznavids_birthplace
		template = HEE_ghaznavid_template
		dynasty_house = house:house_ghaznavid
		save_scope_as = ghaznavid
	}
	
	scope:ghaznavid = {
		# Make temporarily immune to disease
		add_character_flag = {
			flag = immune_to_disease
			years = 15
		}
		add_character_flag = {
			flag = is_party_baron
			years = 5
		}
		add_character_modifier = {
			modifier = the_turkic_conqueror_modifier
		}
		add_trait = turkish_conqueror
		add_prestige = 5000
		add_gold = 2000
		add_piety = 1000
		add_dread = high_dread
		dynasty = {
			add_dynasty_prestige_level = 2
			add_dynasty_prestige = 1000
			add_dynasty_perk = warfare_legacy_1
			add_dynasty_perk = warfare_legacy_2
			add_dynasty_perk = warfare_legacy_3
			if = {
				limit = {
					has_dlc_feature = hybridize_culture
				}
				add_dynasty_perk = ep1_culture_legacy_1
			}
		}
		set_global_variable = {
			name = ghaznaviddynasty
			value = scope:ghaznavid.dynasty
		}
		set_global_variable = {
			name = ghaznavidfounder
			value = scope:ghaznavid
		}
	}

	create_character = {
		name = "Mahmud" 
		father = scope:ghaznavid
		location = scope:ghaznavids_birthplace
		template = HEE_ghaznavid_mahmud_template
		dynasty_house = house:house_ghaznavid
		save_scope_as = Mahmud
	}

	scope:Mahmud = {
		set_global_variable = {
			name = GhaznavidMahmud
			value = scope:Mahmud
		}
	}

	create_character = {
		name = "Ismail"
		father = scope:ghaznavid
		location = scope:ghaznavids_birthplace
		template = HEE_ghaznavid_ismail_template
		dynasty_house = house:house_ghaznavid
		save_scope_as = Ismail
	}

	scope:Ismail = {
		set_global_variable = {
			name = GhaznavidIsmail
			value = scope:Ismail
		}
	}

}

spawn_ghaznavid_troops_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		levies = 100
		location = capital_province
	}
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 10
		}
		men_at_arms = {
			type = horse_archers
			stacks = 20
		}
		levies = 100
		location = capital_province
	}
	
}

ghaznavid_war_target_evaluation_and_declaration_effect = {
	# Set the ghaznavid Emperor as reference point
	save_scope_as = ghaznavid_emperor
	add_character_flag = {
		flag = free_ghaznavid_cb
		days = 14
	}
	# Select a new target
	random_neighboring_top_liege_realm_owner = {
		limit = {
			NOT = { is_allied_to = scope:ghaznavid_emperor }
			NOT = { this = scope:ghaznavid_emperor }
			NOT = { top_liege = scope:ghaznavid_emperor }
			save_temporary_scope_as = truce_check
			NOT = {
				scope:ghaznavid_emperor = {
					any_truce_target = {
						this = scope:truce_check
					}
				}
			}
		}
		weight = {
			base = 0
			modifier = {
				add = ghaznavids_invasion_target_character_weight
				always = yes
			}
		}
		save_temporary_scope_as = next_invasion_target

		if = {
			limit = {
				highest_held_title_tier <= tier_kingdom
				NOT = { has_title = title:k_transoxiana }
			}
			primary_title = {
				save_temporary_scope_as = next_invasion_title_target
			}
		}
		if = {
			limit = {
				highest_held_title_tier <= tier_kingdom
				has_title = title:k_transoxiana
			}
			scope:ghaznavid_emperor = {
				random_realm_province = {
					county = {
						random_neighboring_county = {
							limit = {
								any_in_de_jure_hierarchy = {
									tier = tier_kingdom
									exists = holder
									holder = {
										top_liege = scope:next_invasion_target
									}
								}
							}
							random_in_de_jure_hierarchy = {
								limit = { 
									tier = tier_kingdom
									holder = {
										top_liege = scope:next_invasion_target
									}
									NOT = { holder = scope:ghaznavid_emperor }
									NOT = { holder.top_liege = scope:ghaznavid_emperor }

								}
								save_temporary_scope_as = next_invasion_title_target
								debug_log = "ghaznavid: scoped random neighboring kingdom"
							}
						}	
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					highest_held_title_tier = tier_empire
				}

				scope:ghaznavid_emperor.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
								exists = holder
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_kingdom
								holder = {
									top_liege = scope:next_invasion_target
								}
								NOT = { holder = scope:ghaznavid_emperor }
								NOT = { holder.top_liege = scope:ghaznavid_emperor } 
							}
							save_temporary_scope_as = next_invasion_title_target
							debug_log = "ghaznavid_emperor: scoped random neighboring kingdom"
						}
					}
				}
			}
		}	
	}

	if = {
		limit = {
			exists = scope:next_invasion_target
		}
		if = {
			limit = { # Declare war on every same-tier count or duke in same empire
				scope:next_invasion_target = {
					OR = {
						highest_held_title_tier = tier_county
						highest_held_title_tier = tier_duchy
					}
				}
			}
			scope:next_invasion_title_target = {
				add_to_temporary_list = all_titles_to_declare_on
				kingdom = { #Changed from Empire
					every_in_de_jure_hierarchy = { # Find all other same-tier titles in same de jure empire
						continue = {
							tier > tier_county
							# Stop searching if you hit the seljuk Emperor's territory at any point
							trigger_if = {
								limit = { exists = holder }
								NOT = { holder = scope:ghaznavid_emperor }
								NOT = { holder.top_liege = scope:ghaznavid_emperor }
							}
						}
						limit = {
							exists = this
							OR = {
								tier = tier_county
								tier = tier_duchy
							}
							exists = holder
							holder = {
								is_independent_ruler = yes
								NOT = { this = scope:ghaznavid_emperor }
								NOT = { top_liege = scope:ghaznavid_emperor }
								NOT = { is_at_war_with = scope:ghaznavid_emperor }
								NOT = { is_allied_to = scope:ghaznavid_emperor }
								save_temporary_scope_as = truce_check
								NOT = {
									scope:ghaznavid_emperor = {
										any_truce_target = {
											this = scope:truce_check
										}
									}
								}
							}
						}
						add_to_temporary_list = all_titles_to_declare_on
					}
				}
			}
			every_in_list = {
				list = all_titles_to_declare_on
				limit = {
					holder = {
						# An extra check to make sure we haven't snuck any seljuk territory in
						NOT = { this = scope:ghaznavid_emperor }
						NOT = { top_liege = scope:ghaznavid_emperor }

						# Standard conditions
						NOT = { is_at_war_with = scope:ghaznavid_emperor }
						NOT = {
							is_in_list = has_been_sent_subjugation_offer
						}
						save_temporary_scope_as = truce_check
					}
					NOT = {
						scope:ghaznavid_emperor = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
				}

				holder = {
					add_to_temporary_list = has_been_sent_subjugation_offer
					send_ghaznavid_subjugation_demand_effect = yes
				}
			}
		}
		else_if = {
			limit = {
				scope:next_invasion_target = {
					highest_held_title_tier < tier_empire
				}
			}
			scope:next_invasion_target = {
				send_ghaznavid_subjugation_demand_effect = yes
			}
		}
		else = { # Emperors are not offered ways out
			start_war = {
				cb = seljuk_invasion_war
				target = scope:next_invasion_target
				target_title = scope:next_invasion_title_target.empire
			}
		}
	}
}

send_ghaznavid_subjugation_demand_effect = {
	if = {
		limit = {
			NOT = { is_allied_to = scope:ghaznavid_emperor }
		}
		#AHHHHH
		trigger_event = {
			id = HEE_ghaznavids.5001
			days = { 3 12 }
		}

		save_temporary_scope_as = subjugation_offer_recipient
		scope:ghaznavid_emperor = {
			add_to_variable_list = {
				name = subjugation_offer_under_consideration
				target = scope:subjugation_offer_recipient
			}
		}
	}
	else = {
		if = {
			limit = {
				highest_held_title_tier >= tier_empire
			}
			trigger_event = {
				id = HEE_ghaznavids.2111
				days = { 3 12 }
			}
		}
		else = {
			trigger_event = {
				id = HEE_ghaznavids.2101
				days = { 3 12 }
			}
		}
	}
}

spawn_ghaznavid_reinforcements_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = seljuk_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		levies = 1000
		location = capital_province
	}
}

## Qarmatians ##

spawn_qarmatians_character_effect = {
	title:c_qatif.title_province = {
		save_scope_as = qarmatians_birthplace
	}
	create_character = {
		location = scope:qarmatians_birthplace
		template = HEE_qarmatian_founder_template
		dynasty = inherit
		father = character:74039
		save_scope_as = qarmatian_founder
	}
	
	scope:qarmatian_founder = {
		add_character_flag = {
			flag = no_headgear # Not a seeker of formal royality status and its associated regalia
		}
		# Make temporarily immune to disease
		add_character_flag = {
			flag = immune_to_disease
			years = 10
		}
		add_character_flag = {
			flag = is_party_baron
			years = 5
		}
		add_prestige = 1500
		add_gold = 500
		add_piety = 2000
		add_dread = high_dread
		dynasty = {
			add_dynasty_prestige_level = 1
			add_dynasty_prestige = 500
			add_dynasty_perk = warfare_legacy_1
			add_dynasty_perk = warfare_legacy_2
		}
		set_global_variable = {
			name = qarmatian_dynasty
			value = scope:qarmatian_founder.dynasty
		}
		set_global_variable = {
			name = qarmatian_founder
			value = scope:qarmatian_founder
		}
	}

	create_character = {
		father = scope:qarmatian_founder
		location = scope:qarmatians_birthplace
		template = jannabid_first_son_character_template
		dynasty = inherit
		save_scope_as = Qasim
	}

	scope:Qasim = {
		set_global_variable = {
			name = JannabidQasim
			value = scope:Qasim
		}
	}

	# create_character = {
	# 	name = "Ismail"
	# 	father = scope:ghaznavid
	# 	location = scope:ghaznavids_birthplace
	# 	template = HEE_ghaznavid_ismail_template
	# 	dynasty_house = house:house_ghaznavid
	# 	save_scope_as = Ismail
	# 	add_trait = turkish_conqueror
	# 	set_global_variable = {
	# 		name = GhaznavidIsmail
	# 		value = scope:Ismail
	# 	}
	# 	add_character_modifier = {
	# 		modifier = the_turkic_conqueror_modifier
	# 	}
	# }
}

spawn_qarmatian_starting_troops_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = qarmatian_event_troops
		men_at_arms = {
			type = light_footmen
			stacks = 5
		}
		men_at_arms = {
			type = light_footmen
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = mubarizun
			stacks = 5
		}
		men_at_arms = {
			type = mubarizun
			stacks = 5
		}
		men_at_arms = {
			type = camel_rider
			stacks = 5
		}
		men_at_arms = {
			type = camel_rider
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 3950
		location = global_var:qarmatian_founder.location
	}
}

spawn_qarmatian_reinforcements_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = qarmatian_event_troops
		men_at_arms = {
			type = light_footmen
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = mubarizun
			stacks = 5
		}
		men_at_arms = {
			type = camel_rider
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 1450
		location = global_var:qarmatian_founder.location
	}
}

# Qarmatian targeting for wars
qarmatian_war_target_evaluation_and_declaration_effect = {
	# Set the qarmatian leader as reference point
	save_scope_as = lead_qarmatian

	# Select a new target
	if = { # Check if a direct neighbor is a valid war target
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				NOR = {
					is_allied_to = scope:lead_qarmatian
					this = scope:lead_qarmatian
					top_liege = scope:lead_qarmatian
					current_military_strength > scope:lead_qarmatian.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_qarmatian = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_qarmatian_invasion_region
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			limit = {
				NOR = {
					is_allied_to = scope:lead_qarmatian
					this = scope:lead_qarmatian
					top_liege = scope:lead_qarmatian
					current_military_strength > scope:lead_qarmatian.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_qarmatian = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_qarmatian_invasion_region
				}
			}

			save_temporary_scope_as = next_invasion_target

			if = {
				limit = {
					scope:next_invasion_target = { highest_held_title_tier = tier_empire }
				}

				scope:lead_qarmatian.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_duchy
								target_is_de_facto_liege_or_above = scope:next_invasion_target
								NOT = { target_is_de_facto_liege_or_above = scope:lead_qarmatian }
							}
							kingdom = { save_temporary_scope_as = next_invasion_title_target }
							debug_log = "scope:lead_qarmatian: scoped random neighboring kingdom"
						}
					}
				}
			}

			else = {
				if = {
					limit = {
						NOT = { scope:next_invasion_target = { highest_held_title_tier = tier_empire } }
					}
					primary_title = {
						save_temporary_scope_as = next_invasion_title_target
					}
				}
			}
		}
	}
	else_if = { # if no direct neighbors are valid war targets, then check the neighbors of the neighbors
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					NOR = {
						is_allied_to = scope:lead_qarmatian
						this = scope:lead_qarmatian
						top_liege = scope:lead_qarmatian
						current_military_strength > scope:lead_qarmatian.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_qarmatian = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_qarmatian_invasion_region
					}
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			random_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					NOR = {
						is_allied_to = scope:lead_qarmatian
						this = scope:lead_qarmatian
						top_liege = scope:lead_qarmatian
						current_military_strength > scope:lead_qarmatian.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_qarmatian = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_qarmatian_invasion_region
					}
				}
				save_temporary_scope_as = next_invasion_target
				primary_title = {
					save_temporary_scope_as = next_invasion_title_target
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			NOT = {
				scope:next_invasion_target = {
					highest_held_title_tier = tier_empire
				}
			}
		}
		start_war = {
			cb = religious_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			scope:next_invasion_target = {
				highest_held_title_tier = tier_empire
			}
		}
		start_war = {
			cb = religious_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
}

## Fatimids ##

spawn_ismali_missionary_character_effect = {
	title:c_bejaia.title_province = {
		save_scope_as = kutama_uprising_location
	}
	create_character = {
		name = "Abu_Abdallah"
		location = scope:kutama_uprising_location
		template = HEE_ismaili_missionary_template
		dynasty_house = house:house_al_shii
		save_scope_as = Abu_Abdallah_al_Shii
	}
	
	scope:Abu_Abdallah_al_Shii = {
		add_character_flag = {
			flag = no_headgear # Not a seeker of formal royality status and its associated regalia
		}
		# Make temporarily immune to disease
		add_character_flag = {
			flag = immune_to_disease
			years = 10
		}
		add_character_flag = {
			flag = is_party_baron
			years = 5
		}
		add_prestige = 1500
		add_gold = 500
		add_piety = 2000
		dynasty = {
			add_dynasty_prestige_level = 1
			add_dynasty_prestige = 500
			add_dynasty_perk = law_legacy_1
			add_dynasty_perk = law_legacy_2
		}
		set_global_variable = {
			name = Abu_Abdallah_al_Shii
			value = scope:Abu_Abdallah_al_Shii
		}
	}
}

give_kutama_land_effect = {
	title:c_bejaia = { save_scope_as = c_bejaia }
	title:c_satif = { save_scope_as = c_satif }

	# Give Abu Abdallah al-Shi'i land 
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
		add_claim_on_loss = no
	}
	title:c_bejaia = {
		change_title_holder = {
			holder = scope:Abu_Abdallah_al_Shii
			change = scope:change
		}
	}
	title:c_satif = {
		change_title_holder = {
			holder = scope:Abu_Abdallah_al_Shii
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change

	# Abu Abdallah al-Shi'i breaks if the titles were under a liege
	create_title_and_vassal_change = {
		type = independency
		save_scope_as = going_independent
		add_claim_on_loss = no
	}

	scope:Abu_Abdallah_al_Shii = {
		becomes_independent = {
			change = scope:going_independent
		}
	}
	
	resolve_title_and_vassal_change = scope:going_independent	
}

spawn_fatimid_starting_troops_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = kutama_event_troops
		men_at_arms = {
			type = abudrar
			stacks = 5
		}
		men_at_arms = {
			type = abudrar
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = mulaththamun
			stacks = 5
		}
		men_at_arms = {
			type = mulaththamun
			stacks = 5
		}
		men_at_arms = {
			type = camel_rider
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 2450
		location = global_var:Abu_Abdallah_al_Shii.location
	}
}

spawn_fatimid_reinforcements_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = fatimid_event_troops
		men_at_arms = {
			type = light_footmen
			stacks = 5
		}
		men_at_arms = {
			type = bowmen
			stacks = 5
		}
		men_at_arms = {
			type = mubarizun
			stacks = 5
		}
		men_at_arms = {
			type = camel_rider
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 1450
		location = global_var:Abu_Abdallah_al_Shii.location
	}
}

# Kutama targeting for wars
kutama_war_target_evaluation_and_declaration_effect = {
	# Set the Kutama leader as reference point
	save_scope_as = lead_kutama

	# Select a new target
	if = { # Check if a direct neighbor is a valid war target
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				NOR = {
					is_allied_to = scope:lead_kutama
					this = scope:lead_kutama
					top_liege = scope:lead_kutama
					current_military_strength > scope:lead_kutama.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_kutama = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = core_starting_fatimid_region
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			limit = {
				NOR = {
					is_allied_to = scope:lead_kutama
					this = scope:lead_kutama
					top_liege = scope:lead_kutama
					current_military_strength > scope:lead_kutama.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_kutama = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = core_starting_fatimid_region
				}
			}

			save_temporary_scope_as = next_invasion_target

			if = {
				limit = {
					scope:next_invasion_target = { highest_held_title_tier = tier_empire }
				}

				scope:lead_kutama.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_duchy
								target_is_de_facto_liege_or_above = scope:next_invasion_target
								NOT = { target_is_de_facto_liege_or_above = scope:lead_kutama }
							}
							kingdom = { save_temporary_scope_as = next_invasion_title_target }
							debug_log = "scope:lead_kutama: scoped random neighboring kingdom"
						}
					}
				}
			}

			else = {
				if = {
					limit = {
						NOT = { scope:next_invasion_target = { highest_held_title_tier = tier_empire } }
					}
					primary_title = {
						save_temporary_scope_as = next_invasion_title_target
					}
				}
			}
		}
	}
	else_if = { # if no direct neighbors are valid war targets, then check the neighbors of the neighbors
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					NOR = {
						is_allied_to = scope:lead_kutama
						this = scope:lead_kutama
						top_liege = scope:lead_kutama
						current_military_strength > scope:lead_kutama.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_kutama = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = core_starting_fatimid_region
					}
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			random_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					NOR = {
						is_allied_to = scope:lead_kutama
						this = scope:lead_kutama
						top_liege = scope:lead_kutama
						current_military_strength > scope:lead_kutama.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_kutama = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = core_starting_fatimid_region
					}
				}
				save_temporary_scope_as = next_invasion_target
				primary_title = {
					save_temporary_scope_as = next_invasion_title_target
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			NOT = {
				scope:next_invasion_target = {
					highest_held_title_tier = tier_empire
				}
			}
		}
		start_war = {
			cb = religious_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			scope:next_invasion_target = {
				highest_held_title_tier = tier_empire
			}
		}
		start_war = {
			cb = religious_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
}

spawn_fatimid_caliph_character_effect = {
	title:c_kairwan.title_province = {
		save_scope_as = fatimid_enthronement_location
	}
	create_character = {
		name = "al-Mahdī biʾllāh"
		location = scope:fatimid_enthronement_location
		template = HEE_fatimid_founder_template
		dynasty = inherit
		father = character:33920
		save_scope_as = first_fatimid_caliph
	}
	
	scope:first_fatimid_caliph = {
		# Make temporarily immune to disease
		add_character_flag = {
			flag = immune_to_disease
			years = 10
		}
		add_character_flag = {
			flag = is_party_baron
			years = 5
		}
		add_prestige = 1000
		add_gold = 2500
		add_piety = 1000
		dynasty = {
			add_dynasty_perk = glory_legacy_1
			add_dynasty_perk = glory_legacy_2
		}
		set_global_variable = {
			name = first_fatimid_caliph
			value = scope:first_fatimid_caliph
		}
	}

	create_character = {
		name = "Ja'far"
		location = scope:fatimid_enthronement_location
		template = HEE_fatimid_founder_confidant_template
		save_scope_as = fatimid_founder_confidant
	}

	create_character = {
		name = "al-Qa'im"
		location = scope:fatimid_enthronement_location
		template = HEE_second_fatimid_caliph_template
		dynasty = inherit
		father = scope:first_fatimid_caliph
		save_scope_as = second_fatimid_caliph
	}

	scope:second_fatimid_caliph = {
		set_global_variable = {
			name = second_fatimid_caliph
			value = scope:second_fatimid_caliph
		}
	}
}

# Fatimid targeting for wars
fatimid_war_target_evaluation_and_declaration_effect = {
	# Set the Fatimid leader as reference point
	save_scope_as = lead_fatimid

	# Select a new target
	if = { # Check if a direct neighbor is a valid war target
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				NOR = {
					is_allied_to = scope:lead_fatimid
					this = scope:lead_fatimid
					top_liege = scope:lead_fatimid
					current_military_strength > scope:lead_fatimid.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_fatimid = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_fatimid_invasion_region
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			limit = {
				NOR = {
					is_allied_to = scope:lead_fatimid
					this = scope:lead_fatimid
					top_liege = scope:lead_fatimid
					current_military_strength > scope:lead_fatimid.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_fatimid = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_fatimid_invasion_region
				}
			}

			save_temporary_scope_as = next_invasion_target

			if = {
				limit = {
					scope:next_invasion_target = { highest_held_title_tier = tier_empire }
				}

				scope:lead_fatimid.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_duchy
								target_is_de_facto_liege_or_above = scope:next_invasion_target
								NOT = { target_is_de_facto_liege_or_above = scope:lead_fatimid }
							}
							kingdom = { save_temporary_scope_as = next_invasion_title_target }
							debug_log = "scope:lead_fatimid: scoped random neighboring kingdom"
						}
					}
				}
			}

			else = {
				if = {
					limit = {
						NOT = { scope:next_invasion_target = { highest_held_title_tier = tier_empire } }
					}
					primary_title = {
						save_temporary_scope_as = next_invasion_title_target
					}
				}
			}
		}
	}
	else_if = { # if no direct neighbors are valid war targets, then check the neighbors of the neighbors
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					NOR = {
						is_allied_to = scope:lead_fatimid
						this = scope:lead_fatimid
						top_liege = scope:lead_fatimid
						current_military_strength > scope:lead_fatimid.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_fatimid = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_fatimid_invasion_region
					}
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			random_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					NOR = {
						is_allied_to = scope:lead_fatimid
						this = scope:lead_fatimid
						top_liege = scope:lead_fatimid
						current_military_strength > scope:lead_fatimid.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_fatimid = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_fatimid_invasion_region
					}
				}
				save_temporary_scope_as = next_invasion_target
				primary_title = {
					save_temporary_scope_as = next_invasion_title_target
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			NOT = {
				scope:next_invasion_target = {
					highest_held_title_tier = tier_empire
				}
			}
		}
		start_war = {
			cb = invasion_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			scope:next_invasion_target = {
				highest_held_title_tier = tier_empire
			}
		}
		start_war = {
			cb = invasion_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
}

## Rurikids ##

# Rurikd targeting for wars
rurikid_war_target_evaluation_and_declaration_effect = {
	# Set the qarmatian leader as reference point
	save_scope_as = lead_rurikid

	# Select a new target
	if = { # Check if a direct neighbor is a valid war target
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				NOR = {
					is_allied_to = scope:lead_rurikid
					this = scope:lead_rurikid
					top_liege = scope:lead_rurikid
					current_military_strength > scope:lead_rurikid.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_rurikid = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = rurikid_invasion_region
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			limit = {
				NOR = {
					is_allied_to = scope:lead_rurikid
					this = scope:lead_rurikid
					top_liege = scope:lead_rurikid
					current_military_strength > scope:lead_rurikid.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:lead_rurikid = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = rurikid_invasion_region
				}
			}

			save_temporary_scope_as = next_invasion_target

			if = {
				limit = {
					scope:next_invasion_target = { highest_held_title_tier = tier_empire }
				}

				scope:lead_rurikid.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_duchy
								target_is_de_facto_liege_or_above = scope:next_invasion_target
								NOT = { target_is_de_facto_liege_or_above = scope:lead_rurikid }
							}
							kingdom = { save_temporary_scope_as = next_invasion_title_target }
							debug_log = "scope:lead_rurikid: scoped random neighboring kingdom"
						}
					}
				}
			}

			else = {
				if = {
					limit = {
						NOT = { scope:next_invasion_target = { highest_held_title_tier = tier_empire } }
					}
					primary_title = {
						save_temporary_scope_as = next_invasion_title_target
					}
				}
			}
		}
	}
	else_if = { # if no direct neighbors are valid war targets, then check the neighbors of the neighbors
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					NOR = {
						is_allied_to = scope:lead_rurikid
						this = scope:lead_rurikid
						top_liege = scope:lead_rurikid
						current_military_strength > scope:lead_rurikid.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_rurikid = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = rurikid_invasion_region
					}
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			random_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					NOR = {
						is_allied_to = scope:lead_rurikid
						this = scope:lead_rurikid
						top_liege = scope:lead_rurikid
						current_military_strength > scope:lead_rurikid.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:lead_rurikid = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = rurikid_invasion_region
					}
				}
				save_temporary_scope_as = next_invasion_target
				primary_title = {
					save_temporary_scope_as = next_invasion_title_target
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			NOT = {
				scope:next_invasion_target = {
					highest_held_title_tier = tier_empire
				}
			}
		}
		start_war = {
			cb = tribal_subjugation_cb
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			scope:next_invasion_target = {
				highest_held_title_tier = tier_empire
			}
		}
		start_war = {
			cb = invasion_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
}

spawn_rurikid_reinforcements_effect = {
	save_scope_as = lead_rurikid

	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = rurikid_event_troops
		men_at_arms = {
			type = huscarl
			stacks = 3
		}
		men_at_arms = {
			type = huscarl
			stacks = 3
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 350
		location = scope:lead_rurikid.location
	}
}

TestingEffect = {
	every_held_title = {
		limit = {
			tier = tier_county
		}
		save_temporary_scope_as = current_county
		create_character = {
			location = scope:current_county.title_province
			template = old_country_local_warlord_template
			save_temporary_scope_as = local_warlord
		}
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		hidden_effect = {
			scope:current_county = {
				change_title_holder = {
					holder = scope:local_warlord
					change = scope:change
					take_baronies = yes
				}
			}
		}
		resolve_title_and_vassal_change = scope:change


		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		resolve_title_and_vassal_change = scope:change
	}
}

spawn_pechenegs_starting_troops_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = pecheneg_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 2450
		location = scope:story_owner.capital_province
	}
}

spawn_pechenegs_reinforcements_effect = {
	spawn_army = {
		uses_supply = no
		inheritable = yes
		name = pecheneg_event_troops
		men_at_arms = {
			type = horse_archers
			stacks = 5
		}
		men_at_arms = {
			type = mangonel
			stacks = 5
		}
		levies = 1450
		location = scope:story_owner.capital_province
	}
}

# Pecheneg targeting for wars
pecheneg_war_target_evaluation_and_declaration_effect = {
	# Set the Pecheneg leader as reference point
	save_scope_as = pecheneg_khan

	# Select a new target
	if = { # Check if a direct neighbor is a valid war target
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				NOR = {
					is_allied_to = scope:pecheneg_khan
					this = scope:pecheneg_khan
					top_liege = scope:pecheneg_khan
					current_military_strength > scope:pecheneg_khan.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:pecheneg_khan = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_pecheneg_invasion_region
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			limit = {
				NOR = {
					is_allied_to = scope:pecheneg_khan
					this = scope:pecheneg_khan
					top_liege = scope:pecheneg_khan
					current_military_strength > scope:pecheneg_khan.current_military_strength
				}
				save_temporary_scope_as = truce_check
				NOT = {
					scope:pecheneg_khan = {
						any_truce_target = {
							this = scope:truce_check
						}
					}
				}
				any_realm_province = {
					geographical_region = max_pecheneg_invasion_region
				}
			}

			save_temporary_scope_as = next_invasion_target

			if = {
				limit = {
					scope:next_invasion_target = { highest_held_title_tier = tier_empire }
				}

				scope:pecheneg_khan.primary_title = {
					random_neighboring_county = {
						limit = {
							any_in_de_jure_hierarchy = {
								tier = tier_kingdom
							}
						}
						random_in_de_jure_hierarchy = {
							limit = { 
								tier = tier_duchy
								target_is_de_facto_liege_or_above = scope:next_invasion_target
								NOT = { target_is_de_facto_liege_or_above = scope:pecheneg_khan }
							}
							kingdom = { save_temporary_scope_as = next_invasion_title_target }
							debug_log = "scope:pecheneg_khan: scoped random neighboring kingdom"
						}
					}
				}
			}

			else = {
				if = {
					limit = {
						NOT = { scope:next_invasion_target = { highest_held_title_tier = tier_empire } }
					}
					primary_title = {
						save_temporary_scope_as = next_invasion_title_target
					}
				}
			}
		}
	}
	else_if = { # if no direct neighbors are valid war targets, then check the neighbors of the neighbors
		limit = {
			any_neighboring_and_across_water_top_liege_realm_owner = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					NOR = {
						is_allied_to = scope:pecheneg_khan
						this = scope:pecheneg_khan
						top_liege = scope:pecheneg_khan
						current_military_strength > scope:pecheneg_khan.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:pecheneg_khan = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_pecheneg_invasion_region
					}
				}
			}
		}
		random_neighboring_and_across_water_top_liege_realm_owner = {
			random_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					NOR = {
						is_allied_to = scope:pecheneg_khan
						this = scope:pecheneg_khan
						top_liege = scope:pecheneg_khan
						current_military_strength > scope:pecheneg_khan.current_military_strength
						highest_held_title_tier = tier_empire
					}
					save_temporary_scope_as = truce_check
					NOT = {
						scope:pecheneg_khan = {
							any_truce_target = {
								this = scope:truce_check
							}
						}
					}
					any_realm_province = {
						geographical_region = max_pecheneg_invasion_region
					}
				}
				save_temporary_scope_as = next_invasion_target
				primary_title = {
					save_temporary_scope_as = next_invasion_title_target
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			NOT = {
				scope:next_invasion_target = {
					highest_held_title_tier = tier_empire
				}
			}
		}
		start_war = {
			cb = invasion_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
	if = {
		limit = {
			exists = scope:next_invasion_target
			scope:next_invasion_target = {
				highest_held_title_tier = tier_empire
			}
		}
		start_war = {
			cb = invasion_war
			target = scope:next_invasion_target
			target_title = scope:next_invasion_title_target
		}
	}
}