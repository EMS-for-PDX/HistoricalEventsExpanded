namespace = hee_anarchy_at_samarra

hee_anarchy_at_samarra.0001 = { 
	type = character_event
	title = hee_anarchy_at_samarra.0001.t
	desc = hee_anarchy_at_samarra.0001.desc
	theme = diplomacy # Change
	left_portrait = {
		character = root
		animation = fear
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		#is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}

	#Resend
	on_trigger_fail = {
		if = {
			trigger_event = {
				id = hee_anarchy_at_samarra.0001
				days = 30 #~1 month
			}
		}
	}

	immediate = {
		# Scopes
		character:34014 = { save_scope_as = al_mutazz } # https://en.wikipedia.org/wiki/Al-Mu%27tazz
		character:34015 = { save_scope_as = al_muhtadi } # https://en.wikipedia.org/wiki/Al-Muhtadi
		character:34016 = { save_scope_as = al_mutamid } # https://en.wikipedia.org/wiki/Al-Mu%27tamid
		character:34017 = { save_scope_as = al_muwaffaq } # https://en.wikipedia.org/wiki/Al-Muwaffaq
		character:34018 = { save_scope_as = al_mutadid } # https://en.wikipedia.org/wiki/Al-Mu%27tadid
		
		character:turkish000007 = { save_scope_as = wasif_al_turki } # https://en.wikipedia.org/wiki/Wasif_al-Turki
		character:turkish000008 = { save_scope_as = salih_ibn_wasif } # https://en.wikipedia.org/wiki/Salih_ibn_Wasif
		character:163131 = { save_scope_as = bugha_al_sharabi } # https://en.wikipedia.org/wiki/Bugha_al-Sharabi
		character:163132 = { save_scope_as = musa_bughoglu } # https://en.wikipedia.org/wiki/Musa_ibn_Bugha_al-Kabir
	}

	option = {
		name = hee_anarchy_at_samarra.0001.a

		custom_tooltip = try_to_placate_the_soldiery
		
		hidden_effect = {
			character:turkish000007 = {
				death = {
					death_reason = death_beaten_by_mob
				}
			}
		}
		
		character:turkish000008 = {
			if = {
				limit = {
					is_alive = yes
					is_landed = yes
				}
				trigger_event = {
					id = hee_anarchy_at_samarra.0021
					days = { 5 10 }
				}
			}
		}
		
		character:163131 = {
			if = {
				limit = {
					is_alive = yes
					is_landed = yes
				}
				trigger_event = {
					id = hee_anarchy_at_samarra.0031
					days = { 5 10 }
				}
			}
		}
		
		character:34014 = {
			if = {
				limit = {
					is_alive = yes
					is_landed = yes
				}
				trigger_event = {
					id = hee_anarchy_at_samarra.0002
					days = { 5 10 }
				}
			}
		}
		
		ai_chance = {
			base = 1000
		}
	}

	option = {
		name = hee_anarchy_at_samarra.0001.b
		
		custom_tooltip = try_to_fight_back_against_the_soldiery #ahistorical option
		
		ai_chance = {
			base = 0
		}
	}


}

hee_anarchy_at_samarra.0002 = { # Contemplate moving against Bugha
	type = character_event
	title = hee_anarchy_at_samarra.0002.t
	desc = hee_anarchy_at_samarra.0002.desc
	theme = diplomacy # Change
	left_portrait = {
		character = root
		animation = personality_rational
	}
	right_portrait = {
		character = scope:bugha_al_sharabi
		animation = personality_dishonorable
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		#is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}
	
	immediate = {
		# Scopes
		character:34014 = { save_scope_as = al_mutazz } # https://en.wikipedia.org/wiki/Al-Mu%27tazz
		character:34015 = { save_scope_as = al_muhtadi } # https://en.wikipedia.org/wiki/Al-Muhtadi
		character:34016 = { save_scope_as = al_mutamid } # https://en.wikipedia.org/wiki/Al-Mu%27tamid
		character:34017 = { save_scope_as = al_muwaffaq } # https://en.wikipedia.org/wiki/Al-Muwaffaq
		character:34018 = { save_scope_as = al_mutadid } # https://en.wikipedia.org/wiki/Al-Mu%27tadid
		
		character:turkish000007 = { save_scope_as = wasif_al_turki } # https://en.wikipedia.org/wiki/Wasif_al-Turki
		character:turkish000008 = { save_scope_as = salih_ibn_wasif } # https://en.wikipedia.org/wiki/Salih_ibn_Wasif
		character:163131 = { save_scope_as = bugha_al_sharabi } # https://en.wikipedia.org/wiki/Bugha_al-Sharabi
		character:163132 = { save_scope_as = musa_bughoglu } # https://en.wikipedia.org/wiki/Musa_ibn_Bugha_al-Kabir
	}

	option = {
		name = hee_anarchy_at_samarra.0002.a

		custom_tooltip = move_against_bugha
		

		trigger_event = {
			id = hee_anarchy_at_samarra.0003
			days = { 10 15 }
		}
		
		ai_chance = {
			base = 1000
		}
	}

	option = {
		name = hee_anarchy_at_samarra.0002.b
		
		custom_tooltip = do_not_move_against_bugha #ahistorical option
		
		ai_chance = {
			base = 0
		}
	}


}

hee_anarchy_at_samarra.0003 = { # Reach out to Salih for a possible alliance
	type = character_event
	title = hee_anarchy_at_samarra.0003.t
	desc = hee_anarchy_at_samarra.0003.desc
	theme = diplomacy # Change
	left_portrait = {
		character = root
		animation = personality_compassionate
	}
	right_portrait = {
		character = scope:salih_ibn_wasif
		animation = personality_cynical
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		#is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}
	
	option = {
		name = hee_anarchy_at_samarra.0003.a

		custom_tooltip = grant_salih_his_desired_appointments
		

		# trigger_event = {
			# id = hee_anarchy_at_samarra.0003
			# days = { 10 15 }
		# }
		
		ai_chance = {
			base = 1000
		}
	}

	option = {
		name = hee_anarchy_at_samarra.0003.b
		
		custom_tooltip = do_not_move_against_bugha #ahistorical option
		
		ai_chance = {
			base = 0
		}
	}
}

hee_anarchy_at_samarra.1000 = { # Al-Mu'tazz deposition
	type = character_event
	title = hee_anarchy_at_samarra.1000.t
	desc = hee_anarchy_at_samarra.1000.desc
	theme = diplomacy # Change
	left_portrait = {
		character = root
		animation = fear
	}
	right_portrait = {
		character = scope:salih_ibn_wasif
		animation = personality_cynical
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		#is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}

	immediate = {
		# Scopes
		character:34014 = { save_scope_as = al_mutazz } # https://en.wikipedia.org/wiki/Al-Mu%27tazz
		character:34015 = { save_scope_as = al_muhtadi } # https://en.wikipedia.org/wiki/Al-Muhtadi
		character:34016 = { save_scope_as = al_mutamid } # https://en.wikipedia.org/wiki/Al-Mu%27tamid
		character:34017 = { save_scope_as = al_muwaffaq } # https://en.wikipedia.org/wiki/Al-Muwaffaq
		character:34018 = { save_scope_as = al_mutadid } # https://en.wikipedia.org/wiki/Al-Mu%27tadid
		
		character:turkish000007 = { save_scope_as = wasif_al_turki } # https://en.wikipedia.org/wiki/Wasif_al-Turki
		character:turkish000008 = { save_scope_as = salih_ibn_wasif } # https://en.wikipedia.org/wiki/Salih_ibn_Wasif
		character:163131 = { save_scope_as = bugha_al_sharabi } # https://en.wikipedia.org/wiki/Bugha_al-Sharabi
		character:163132 = { save_scope_as = musa_bughoglu } # https://en.wikipedia.org/wiki/Musa_ibn_Bugha_al-Kabir
	}
	
	option = {
		name = hee_anarchy_at_samarra.1000.a

		custom_tooltip = plead_with_salih
		
		set_designated_heir_unsafe = character:34015
		
		if = {
			limit = {
				scope:al_mutazz = { has_character_modifier = anarchy_at_samarra_financial_straits }
			}
			character:34015 = { add_character_modifier = anarchy_at_samarra_financial_straits }
		}
		
		if = {
			limit = {
				scope:al_mutazz = { has_character_modifier = anarchy_at_samarra_loss_of_central_authority }
			}
			character:34015 = { add_character_modifier = anarchy_at_samarra_loss_of_central_authority }
		}

		if = {
			limit = {
				scope:al_mutazz = { has_character_modifier = anarchy_at_samarra_unpaid_soldiery }
			}
			character:34015 = { add_character_modifier = anarchy_at_samarra_unpaid_soldiery }
		}
		
		depose = yes

		imprison_character_effect = {
			TARGET = scope:al_mutazz
			IMPRISONER = scope:salih_ibn_wasif
		}

		trigger_event = {
			id = hee_anarchy_at_samarra.1001
			days = { 3 5 }
		}
		
		ai_chance = {
			base = 1000
		}
	}

	option = {
		name = hee_anarchy_at_samarra.1000.b
		
		custom_tooltip = curse_salih 
		
		set_designated_heir_unsafe = character:34015
		
		depose = yes

		imprison_character_effect = {
			TARGET = scope:al_mutazz
			IMPRISONER = scope:salih_ibn_wasif
		}

		trigger_event = {
			id = hee_anarchy_at_samarra.1001
			days = { 3 5 }
		}
		
		ai_chance = {
			base = 0
		}
	}
}

hee_anarchy_at_samarra.1001 = { # Al-Mutazz's death
	type = character_event
	title = hee_anarchy_at_samarra.1001.t
	desc = hee_anarchy_at_samarra.1001.desc
	theme = prison
	override_background = { reference = dungeon }
	left_portrait = {
		character = root
		animation = prisondungeon
	}
	# right_portrait = {
		# character = scope:salih_ibn_wasif
		# animation = personality_cynical
	# }

	trigger = {
		scope:al_mutazz = { is_alive = yes }
		scope:al_mutazz = { is_landed = no }
		scope:al_mutazz = { is_imprisoned = yes }
	}
	
	immediate = {
		scope:al_muhtadi = {
			trigger_event = {
				id = hee_anarchy_at_samarra.2000
				days = { 350 370 }
			}
		}
	}

	option = { # Die
		name = hee_anarchy_at_samarra.1001.a

		hidden_effect = {
			death = {
				death_reason = death_dungeon
			}
		}
		
		ai_chance = {
			base = 1000
		}
	}
}

hee_anarchy_at_samarra.2000 = { # Al-Muhtadi murder
	type = character_event
	title = hee_anarchy_at_samarra.2000.t
	desc = hee_anarchy_at_samarra.2000.desc
	theme = diplomacy # Change
	left_portrait = {
		character = root
		animation = fear
	}
	right_portrait = {
		character = scope:musa_bughoglu
		animation = personality_vengeful
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		#is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}

	immediate = {
		# Scopes
		# character:34014 = { save_scope_as = al_mutazz } # https://en.wikipedia.org/wiki/Al-Mu%27tazz
		character:34015 = { save_scope_as = al_muhtadi } # https://en.wikipedia.org/wiki/Al-Muhtadi
		character:34016 = { save_scope_as = al_mutamid } # https://en.wikipedia.org/wiki/Al-Mu%27tamid
		character:34017 = { save_scope_as = al_muwaffaq } # https://en.wikipedia.org/wiki/Al-Muwaffaq
		character:34018 = { save_scope_as = al_mutadid } # https://en.wikipedia.org/wiki/Al-Mu%27tadid
		
		character:turkish000007 = { save_scope_as = wasif_al_turki } # https://en.wikipedia.org/wiki/Wasif_al-Turki
		character:turkish000008 = { save_scope_as = salih_ibn_wasif } # https://en.wikipedia.org/wiki/Salih_ibn_Wasif
		character:163131 = { save_scope_as = bugha_al_sharabi } # https://en.wikipedia.org/wiki/Bugha_al-Sharabi
		character:163132 = { save_scope_as = musa_bughoglu } # https://en.wikipedia.org/wiki/Musa_ibn_Bugha_al-Kabir

	}
	
	option = {
		name = hee_anarchy_at_samarra.2000.a

		#Al-Mu'tamid recieves the title of Caliph and the "capital" of Samarra
		scope:al_mutamid = {
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
				add_claim_on_loss = yes
			}
			
			title:d_sunni = {
				change_title_holder = {
					holder = scope:al_mutamid
					change = scope:change
				}
			}

			title:c_samarra = {
				change_title_holder = {
					holder = scope:al_mutamid
					change = scope:change
				}
			}
			
			resolve_title_and_vassal_change = scope:change
		}
		
		set_designated_heir_unsafe = scope:al_mutamid

		if = {
			limit = {
				character:34015 = { has_character_modifier = anarchy_at_samarra_financial_straits }
			}
			character:34017 = { add_character_modifier = anarchy_at_samarra_financial_straits }
		}
		
		if = {
			limit = {
				character:34015 = { has_character_modifier = anarchy_at_samarra_loss_of_central_authority }
			}
			character:34017 = { add_character_modifier = anarchy_at_samarra_loss_of_central_authority }
		}

		if = {
			limit = {
				character:34015 = { has_character_modifier = anarchy_at_samarra_unpaid_soldiery }
			}
			character:34017 = { add_character_modifier = anarchy_at_samarra_unpaid_soldiery }
		}	

		known_murder_effect = {
			VICTIM = character:34015
			MURDERER = character:163132
			EXPOSER = character:163132
		}

		scope:al_mutamid = {
			trigger_event = {
				id = hee_anarchy_at_samarra.2001
				days = { 10 15 }
			}
		}
		
		ai_chance = {
			base = 1000
		}
	}

	option = {
		name = hee_anarchy_at_samarra.2000.b
		
		#Al-Mu'tamid recieves the title of Caliph, but nothing else
		scope:al_mutamid = {
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
				add_claim_on_loss = yes
			}
			
			title:d_sunni = {
				change_title_holder = {
					holder = scope:al_mutamid
					change = scope:change
				}
			}
			
			resolve_title_and_vassal_change = scope:change
		}
		
		set_designated_heir_unsafe = character:34017 # Al-Muwaffaq

		known_murder_effect = {
			VICTIM = character:34015
			MURDERER = character:163132
			EXPOSER = character:163132
		}
		
		ai_chance = {
			base = 0
		}
	}
}

hee_anarchy_at_samarra.2001 = { # Al-Muhtadi has his power usurped by al-Muwaffaq due to al-Muwaffaq's Turkish support
	type = character_event
	title = hee_anarchy_at_samarra.2000.t
	desc = hee_anarchy_at_samarra.2000.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = fear
	}
	right_portrait = {
		character = scope:al_muwaffaq
		animation = personality_rational
	}

	trigger = {
		is_alive = yes
		is_landed = yes
		is_independent_ruler = yes
		#is_at_war = no
		is_imprisoned = no
	}

	immediate = {
		# Scopes
		character:34015 = { save_scope_as = al_muhtadi } # https://en.wikipedia.org/wiki/Al-Muhtadi
		character:34016 = { save_scope_as = al_mutamid } # https://en.wikipedia.org/wiki/Al-Mu%27tamid
		character:34017 = { save_scope_as = al_muwaffaq } # https://en.wikipedia.org/wiki/Al-Muwaffaq
		character:34018 = { save_scope_as = al_mutadid } # https://en.wikipedia.org/wiki/Al-Mu%27tadid
		
		character:turkish000007 = { save_scope_as = wasif_al_turki } # https://en.wikipedia.org/wiki/Wasif_al-Turki
		character:turkish000008 = { save_scope_as = salih_ibn_wasif } # https://en.wikipedia.org/wiki/Salih_ibn_Wasif
		character:163131 = { save_scope_as = bugha_al_sharabi } # https://en.wikipedia.org/wiki/Bugha_al-Sharabi
		character:163132 = { save_scope_as = musa_bughoglu } # https://en.wikipedia.org/wiki/Musa_ibn_Bugha_al-Kabir

	}
	
	option = {
		name = hee_anarchy_at_samarra.2001.a

		scope:al_mutamid = {
			every_vassal = {
				add_to_temporary_list = arabian_vassals
			}
		}

		#Al-Muwaffak recieves Baghdad, the soon-to-be restored capital of the Abbasids
		scope:al_muwaffaq = {
			create_title_and_vassal_change = {
				type = usurped
				save_scope_as = change
				add_claim_on_loss = yes
			}

			title:e_arabia = {
				change_title_holder = {
					holder = scope:al_muwaffaq
					change = scope:change
				}
			}

			title:d_baghdad = {
				change_title_holder = {
					holder = scope:al_muwaffaq
					change = scope:change
				}
			}

			title:c_baghdad = {
				change_title_holder = {
					holder = scope:al_muwaffaq
					change = scope:change
				}
			}

			title:c_anbar = {
				change_title_holder = {
					holder = scope:al_muwaffaq
					change = scope:change
				}
			}

			resolve_title_and_vassal_change = scope:change
		}

		scope:al_muwaffaq = {
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
				add_claim_on_loss = yes
			}
			every_in_list = {
				list = arabian_vassals
				change_liege = {
					liege = scope:al_muwaffaq
					change = scope:change
				}
			}
			scope:al_mutamid = {
				change_liege = {
					liege = scope:al_muwaffaq
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		}

		if = {
			limit = {
				scope:al_mutamid = { has_character_modifier = anarchy_at_samarra_financial_straits }
			}
			scope:al_mutamid = { remove_character_modifier = anarchy_at_samarra_financial_straits }
			scope:al_muwaffaq = { add_character_modifier = anarchy_at_samarra_financial_straits }
		}
		
		if = {
			limit = {
				scope:al_mutamid = { has_character_modifier = anarchy_at_samarra_loss_of_central_authority }
			}
			scope:al_mutamid = { remove_character_modifier = anarchy_at_samarra_financial_straits }
			scope:al_muwaffaq = { add_character_modifier = anarchy_at_samarra_loss_of_central_authority }
		}

		if = {
			limit = {
				scope:al_mutamid = { has_character_modifier = anarchy_at_samarra_unpaid_soldiery }
			}
			scope:al_mutamid = { remove_character_modifier = anarchy_at_samarra_financial_straits }
			scope:al_muwaffaq = { add_character_modifier = anarchy_at_samarra_unpaid_soldiery }
		}	

		# trigger_event = {
			# id = hee_anarchy_at_samarra.0003
			# days = { 10 15 }
		# }
		
		ai_chance = {
			base = 1000
		}
	}
}

hee_anarchy_at_samarra.9000 = {
	scope = none
	hidden = yes

	trigger = {
		has_character_modifier = anarchy_at_samarra_loss_of_central_authority
		is_alive = yes
		is_landed = yes
		is_independent_ruler = yes
		#is_at_war = no
		#is_imprisoned = no
	}

	immediate = {
		trigger_event = {
			id = hee_anarchy_at_samarra.9001
			days = { 180 540 } #~1 month
		}

		title:k_jerusalem = { save_scope_as = k_jerusalem }
		title:k_syria = { save_scope_as = k_syria }
		title:k_anatolia = { save_scope_as = k_anatolia }
		title:k_jazira = { save_scope_as = k_jazira }
		title:k_arabia = { save_scope_as = k_arabia }
		title:k_mesopotamia = { save_scope_as = k_mesopotamia }
		title:k_armenia = { save_scope_as = k_armenia }
		title:k_daylam = { save_scope_as = k_daylam }
		title:k_cyprus = { save_scope_as = k_cyprus }
		title:k_armenian_principality = { save_scope_as = k_armenian_principality }
		
		title:d_damascus = { save_scope_as = d_damascus }
		title:d_shammar = { save_scope_as = d_shammar }
		title:d_lebanon = { save_scope_as = d_lebanon }
		title:d_homs = { save_scope_as = d_homs }
		title:d_cilicia = { save_scope_as = d_cilicia }
		title:d_muslim_tbilisi = { save_scope_as = d_muslim_tbilisi }

		every_vassal = {
			limit = {
				or = {
					primary_title = {
						or = {
							target_is_de_jure_liege_or_above = scope:k_jerusalem
							target_is_de_jure_liege_or_above = scope:k_cyprus
							target_is_de_jure_liege_or_above = scope:k_armenia
							target_is_de_jure_liege_or_above = scope:k_daylam
							target_is_de_jure_liege_or_above = scope:d_damascus
							target_is_de_jure_liege_or_above = scope:d_shammar
							target_is_de_jure_liege_or_above = scope:d_lebanon
							target_is_de_jure_liege_or_above = scope:d_homs
						}
					}
					primary_title = scope:k_armenian_principality
					primary_title = scope:d_homs
					primary_title = scope:d_shammar
					primary_title = scope:d_lebanon
					primary_title = scope:d_damascus
					primary_title = scope:d_cilicia
					primary_title = scope:d_muslim_tbilisi
				}
			}
			add_to_list = distant_vassals
		}

		create_title_and_vassal_change = {
			type = independency
			save_scope_as = going_independent
			add_claim_on_loss = no
		}
		every_in_list = {
			list = distant_vassals
			becomes_independent = {
				change = scope:going_independent
			}
		}
		resolve_title_and_vassal_change = scope:going_independent
	}
}

hee_anarchy_at_samarra.9001 = {
	scope = none
	hidden = yes

	trigger = {
		has_character_modifier = anarchy_at_samarra_loss_of_central_authority
		is_alive = yes
		is_landed = yes
		is_independent_ruler = yes
		#is_at_war = no
		#is_imprisoned = no
	}

	immediate = {
		title:k_jerusalem = { save_scope_as = k_jerusalem }
		title:k_syria = { save_scope_as = k_syria }
		title:k_anatolia = { save_scope_as = k_anatolia }
		title:k_jazira = { save_scope_as = k_jazira }
		title:k_arabia = { save_scope_as = k_arabia }
		title:k_mesopotamia = { save_scope_as = k_mesopotamia }
		title:k_armenia = { save_scope_as = k_armenia }
		title:k_daylam = { save_scope_as = k_daylam }
		title:k_cyprus = { save_scope_as = k_cyprus }
		
		title:d_jawf = { save_scope_as = d_jawf }
		title:d_aleppo = { save_scope_as = d_aleppo }
		title:d_palmyra = { save_scope_as = d_palmyra }
		title:d_edessa = { save_scope_as = d_edessa }
		title:d_diyarbakr = { save_scope_as = d_diyarbakr }
		title:d_diyarrabia = { save_scope_as = d_diyarrabia }
		title:d_diyarmudar = { save_scope_as = d_diyarmudar }

		title:c_al_jawf = { save_scope_as = c_al_jawf }
		title:c_thalabiya = { save_scope_as = c_thalabiya }

		every_vassal = {
			limit = {
				or = {
					primary_title = {
						or = {
							target_is_de_jure_liege_or_above = scope:k_syria
							target_is_de_jure_liege_or_above = scope:d_jawf
						}
					}
					primary_title = scope:d_aleppo
					primary_title = scope:d_palmyra
					primary_title = scope:d_edessa
					primary_title = scope:d_diyarbakr
					primary_title = scope:d_diyarrabia
					primary_title = scope:d_diyarmudar
					primary_title = scope:d_jawf
					primary_title = scope:c_al_jawf
					primary_title = scope:c_thalabiya
				}
			}
			add_to_list = distant_vassals
		}

		create_title_and_vassal_change = {
			type = independency
			save_scope_as = going_independent
			add_claim_on_loss = no
		}
		every_in_list = {
			list = distant_vassals
			becomes_independent = {
				change = scope:going_independent
			}
		}
		resolve_title_and_vassal_change = scope:going_independent

		# Dissolve the Empire
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_change
			add_claim_on_loss = yes
		}
		
		title:k_mesopotamia = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		
		destroy_title = title:e_arabia
	}
}



### AaS Peril Events ###
AaS_peril.0001 = { # Prominent religious officials (ulama) condemn outside influence (Turkish) influence on the Caliphate
	type = character_event
	title = AaS_peril.0001.t
	desc = AaS_peril.0001.desc
	theme = learning
	override_background = { reference = council_chamber } #
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = scope:religious_official
		animation = personality_zealous
	}

	trigger = {
		has_character_modifier = anarchy_at_samarra_loss_of_central_authority
		is_alive = yes
		is_landed = yes
		is_independent_ruler = yes
		is_imprisoned = no
	}

	#Resend
	on_trigger_fail = {
		if = {
			trigger_event = {
				id = AaS_peril.0001
				days = 30 #~1 month
			}
		}
	}

	immediate = {
		create_character = {
			location = root.capital_province
			age = { 45 60 }
			gender = male
			random_traits_list = { #Personality traits
				count = 3
				honest = {}
				zealous = {}
				brave = {}
				calm = {}
				stubborn = {}
				just = {}
			}
			
			random_traits_list = {
				count = 1
				education_learning_3  = {}
				education_learning_4  = {}
				education_learning_5  = {}
			}

			trait = celibate
			
			faith = root.faith
			culture = root.culture
			dynasty = none

			diplomacy = {
				min_template_high_skill
				max_template_high_skill
			}
			learning = {
				min_template_high_skill
				max_template_high_skill
			}

			after_creation = {
				# Perks
				add_perk = faithful_perk
				add_perk = zealous_proselytizer_perk
				add_perk = religious_icon_perk
				add_perk = prophet_perk
				add_perk = clerical_justifications_perk
				add_perk = church_and_state_perk
				add_perk = radiant_perk
				add_perk = defender_of_the_faith_perk
				add_perk = theologian_perk
				add_trait = theologian

				# High Piety
				add_piety = 750
				add_piety_level = 3
			}
			save_scope_as = religious_official
		}
	}

	option = { # Condemn the religious official's rhetoric
		name = AaS_peril.0001.a

		# custom_tooltip = 

		add_piety = medium_piety_loss

		every_vassal = {
			limit = {
				has_vassal_stance = zealot
			}
			custom = every_zealot_vassal
			add_opinion = {
				target = root
				modifier = insult_opinion
				opinion = -35
			}
		}

		every_vassal = {
			limit = {
				has_vassal_stance = minority
			}
			custom = every_minority_vassal
			add_opinion = {
				target = root
				modifier = pleased_opinion
				opinion = 10
			}
		}
		
		ai_chance = {
			base = 1000
		}
	}

	option = { # Try and temper the religious official's rhetoric
		name = AaS_peril.0001.b
		
		# custom_tooltip =  

		duel = {
			skills = { diplomacy learning }
			value = high_skill_rating
			# Crit success.
			20 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 2
					min = -49
				}
				desc = AaS_peril.0001.b.crit_success
				every_vassal = {
					limit = {
						has_vassal_stance = zealot
					}
					custom = every_zealot_vassal
					add_opinion = {
						target = root
						modifier = impressed_opinion
						opinion = 15
					}
				}

				every_vassal = {
					limit = {
						has_vassal_stance = minority
					}
					custom = every_minority_vassal
					add_opinion = {
						target = root
						modifier = pleased_opinion
						opinion = 20
					}
				}
			}
			# Success.
			40 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 2
					min = -49
				}
				desc = AaS_peril.0001.b.success
				send_interface_toast = {
					type = event_toast_effect_good
					title = tournament_events.1310.b.success
					left_icon = root
					right_icon = scope:famous_knight

					activity_tournament_change_contestant_score_effect = { SCORE = increase_miniscule }
				}
			}
			# Failure.
			40 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -2
					min = -49
				}
				desc = AaS_peril.0001.b.failure
				every_vassal = {
					limit = {
						has_vassal_stance = zealot
					}
					custom = every_zealot_vassal
					add_opinion = {
						target = root
						modifier = disappointed_opinion
						opinion = -10
					}
				}

				every_vassal = {
					limit = {
						has_vassal_stance = minority
					}
					custom = every_minority_vassal
					add_opinion = {
						target = root
						modifier = insult_opinion
						opinion = -25
					}
				}
			}
		}

		ai_chance = {
			base = 0
		}
	}

	option = { # Support the religious official's rhetoric  
		name = AaS_peril.0001.c
		
		# custom_tooltip =  

		add_piety = medium_piety_gain

		add_courtier = scope:religious_official

		every_vassal = {
			limit = {
				has_vassal_stance = zealot
			}
			custom = every_zealot_vassal
			add_opinion = {
				target = root
				modifier = pleased_opinion
				opinion = 10
			}
		}

		every_vassal = {
			limit = {
				has_vassal_stance = minority
			}
			custom = every_minority_vassal
			add_opinion = {
				target = root
				modifier = insult_opinion
				opinion = -35
			}
		}

		ai_chance = {
			base = 0
		}
	}
}

AaS_peril.0002 = { # Your Vizier/Spymaster has discovered one of your servants is a spy for your rivals at court.
	type = character_event
	title = AaS_peril.0002.t
	desc = AaS_peril.0002.desc
	theme = intrigue
	override_background = { reference = council_chamber } #
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = scope:vizier
		animation = personality_cynical
	}

	trigger = {
		# Standard checks.
		is_available_at_peace_adult = yes
		# Diarchy checks.
		has_diarchy_active_parameter = diarchy_is_vizierate
		NOT = { has_diarchy_active_parameter = vizier_cannot_be_snaked }
		# Anarchy Check
		has_character_modifier = anarchy_at_samarra_loss_of_central_authority
	}

	weight_multiplier = {
		base = 1
		
		# Weight up if your diarch is loyal.
		modifier = {
			add = 0.5
			diarch.diarch_loyalty >= diarch_loyalty_visibly_loyal_threshold
		}
		# Weight down if they're disloyal.
		modifier = {
			add = -0.5
			diarch.diarch_loyalty <= diarch_loyalty_visibly_disloyal_threshold
		}
	}

	#Resend
	on_trigger_fail = {
		if = {
			trigger_event = {
				id = AaS_peril.0002
				days = 30 #~1 month
			}
		}
	}

	immediate = {
		## Nab the vizier for ease of loc.
		diarch = { save_scope_as = vizier }
	}

	option = { # Execute the spy
		name = AaS_peril.0002.a

		add_small_peril_effect = yes 
		
		ai_chance = {
			base = 1000
		}
	}

	option = { # Try and feed the spy false info
		name = AaS_peril.0002.b
		
		duel = {
			skill = intrigue
			value = medium_skill_rating
			# Success.
			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 2
					min = -49
				}
				desc = AaS_peril.0001.b.success
				decrease_medium_peril_effect = yes
			}
			# Failure.
			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -2
					min = -49
				}
				desc = AaS_peril.0001.b.failure
				add_small_peril_effect = yes
			}
		}

		ai_chance = {
			base = 0
		}
	}

	option = { # Leave the spy be
		name = AaS_peril.0002.c
		
		decrease_small_peril_effect = yes

		ai_chance = {
			base = 0
		}
	}

}

AaS_peril.0003 = { # Your Vizier/Steward knows the caliphate needs money, and suggests debasing the currency for cash
	type = character_event
	title = AaS_peril.0003.t
	desc = AaS_peril.0003.desc
	theme = stewardship
	override_background = { reference = council_chamber } #
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = scope:vizier
		animation = personality_rational
	}

	trigger = {
		# Standard checks.
		is_available_at_peace_adult = yes
		# Diarchy checks.
		has_diarchy_active_parameter = diarchy_is_vizierate
		NOT = { has_diarchy_active_parameter = vizier_cannot_be_snaked }
		# Anarchy Check
		has_character_modifier = anarchy_at_samarra_financial_straits
	}

	weight_multiplier = {
		base = 1
		
		# Weight up if your diarch is loyal.
		modifier = {
			add = 0.5
			diarch.diarch_loyalty >= diarch_loyalty_visibly_loyal_threshold
		}
		# Weight down if they're disloyal.
		modifier = {
			add = -0.5
			diarch.diarch_loyalty <= diarch_loyalty_visibly_disloyal_threshold
		}
	}

	#Resend
	on_trigger_fail = {
		if = {
			trigger_event = {
				id = AaS_peril.0003
				days = 30 #~1 month
			}
		}
	}

	immediate = {
		## Nab the vizier for ease of loc.
		diarch = { save_scope_as = vizier }
	}

	option = { # Raise taxes
		name = stewardship_wealth.1021.a
		every_sub_realm_county = {
			custom = stewardship_wealth.1021.a.custom
			add_county_modifier = {
				modifier = governance_1021_war_taxes_modifier
				years = 3
			}	
		}

		stress_impact = {
			compassionate = minor_stress_impact_gain
			generous = minor_stress_impact_gain
		}
		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_greed = 2
				ai_compassion = -1
				ai_honor = 2
			}
		}	
	}

	option = {
		name = stewardship_wealth.1011.c

		add_stewardship_lifestyle_xp = medium_lifestyle_experience

		duel = {
			skill = stewardship
			value = 10

			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
				}
				desc = stewardship_wealth.1011.c.success
				send_interface_toast = {
					type = event_toast_effect_good
					title = stewardship_wealth.1011.c.success
					left_icon = root

					#Add silver coins modifier to realm.
					every_sub_realm_county = {
						custom = stewardship_wealth.1011.custom
						add_county_modifier = {
							modifier = governance_newly_minted_silver_coins_modifier
							days = 1825
						}		
					}

					#Adds gold to the character's treasury.
					add_gold = medium_gold_value
				}
			}
			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
				}
				desc = stewardship_wealth.1011.c.failure
				send_interface_toast = {
					type = event_toast_effect_bad
					title = stewardship_wealth.1011.c.failure
					left_icon = root
					
					add_prestige = medium_prestige_loss
				}
			}
		}		


		stress_impact = {
			generous = medium_stress_impact_gain
			honest = medium_stress_impact_gain
		}
		ai_chance = {
			base = 50
			ai_value_modifier = {
				ai_greed = 3
				ai_honor = -1
			}
		}			
	}

	option = { # Do nothing
		name = AaS_peril.0003.c

		ai_chance = {
			base = 0
		}
	}
}

scripted_trigger aas_peril_famine_valid_province_trigger = {
	OR = {
		has_province_modifier = recently_looted_modifier
		has_province_modifier = disease_spreading_modifier
		has_province_modifier = winter_harsh_modifier
		barony = {
			exists = holder
			holder = {
				has_character_flag = recently_occupied_flag
			}
		}
	}
	barony = {
		exists = holder
		holder = {
			NOT = {
				this = root
			}
			is_available_ai_adult = yes
			has_court_event_flag = no
		}
	}
}

AaS_peril.0004 = {
	type = character_event
	title = AaS_peril.0004.t
	desc = AaS_peril.0004.desc
	theme = stewardship
	override_background = { reference = council_chamber } #
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = scope:vizier
		animation = personality_rational
	}

	cooldown = { years = 10 }

	trigger = {
		any_realm_province = {
			aas_peril_famine_valid_province_trigger = yes
		}
	}

	weight_multiplier = {
		base = 1
	}

	immediate = {
		random_realm_province = {
			limit = {
				aas_peril_famine_valid_province_trigger = yes
			}
			save_scope_as = 6000_province
		}
		scope:6000_province = {
			barony = {
				holder = {
					save_scope_as = 6000_poor
				}
			}
		}
		if = {
			limit = {
				scope:6000_province.county.holder = {
					NOR = {
						this = root
						this = scope:6000_poor
					}
				}
			}
			scope:6000_province.county.holder = {
				save_scope_as = 6000_count
			}
		}
	}

	#Option A: send money
	option = {
		name = hold_court.6000.a
		trigger = {
			trigger_if = {
				limit = {
					is_ai = yes
				}
				short_term_gold >= medium_gold_value
			}
		}
		pay_short_term_gold = {
			target = scope:6000_poor
			gold = medium_gold_value
		}
		add_hook = {
			type = favor_hook
			target = scope:6000_poor
		}
		every_sub_realm_county = {
			limit = {
				title_province = { aas_peril_famine_valid_province_trigger = yes }
			}
			add_county_modifier = {
				modifier = invested_in_province_modifier
				years = 10
			}
		}
		if = {
			limit = { exists = scope:6000_count }
			scope:6000_count = {
				add_opinion = {
					target = root
					modifier = grateful_opinion
					opinion = 20
				}
			}
		}
		stress_impact = {
			greedy = medium_stress_impact_gain
		}
		ai_chance = {
			base = 5

			modifier = {
				gold < 0
				add = -10
			}
			modifier = {
				short_term_gold >= medium_gold_value
				add = 5
			}
			modifier = {
				OR = {
					has_trait = generous
					has_trait = improvident
					has_trait = profligate
				}
				add = 15
			}
		}
	}

	#Option B: less taxes
	option = {
		name = hold_court.6000.b
		every_sub_realm_county = {
			limit = {
				title_province = { aas_peril_famine_valid_province_trigger = yes }
			}
			add_county_modifier = {
				modifier = court_tax_relief_county_modifier
				years = 10
			}
		}
		if = {
			limit = { exists = scope:6000_count }
			scope:6000_count = {
				add_opinion = {
					target = root
					modifier = grateful_opinion
					opinion = 30
				}
			}
		}
		add_hook = {
			type = indebted_hook
			target = scope:6000_poor
		}
		stress_impact = {
			greedy = medium_stress_impact_gain
		}
		ai_chance = {
			base = 5

			modifier = {
				gold < 0
				add = -5
			}
			modifier = {
				OR = {
					has_trait = greedy
					ai_greed >= medium_positive_ai_value
				}
				add = -10
			}
		}
	}

	#Option D: they can manage it on their own
	option = {
		name = hold_court.6000.d
		stress_impact = {
			generous = medium_stress_impact_gain
			compassionate = medium_stress_impact_gain
			gregarious = medium_stress_impact_gain
			just = medium_stress_impact_gain
		}
		ai_chance = {
			base = 2

			modifier = {
				has_trait = lazy
				add = 10
			}
			modifier = {
				OR = {
					has_trait = just
					has_trait = generous
					has_trait = compassionate
					has_trait = gregarious
				}
				add = -5
			}
		}
	}
}

AaS_peril.0005 = { # You need money - Tax pilgrims undergoing the Umrah/Hajj?
	type = character_event
	title = AaS_peril.0003.t
	desc = AaS_peril.0003.desc
	theme = stewardship
	override_background = { reference = council_chamber } #
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = scope:vizier
		animation = personality_rational
	}

	trigger = {
		# Standard checks.
		is_available_at_peace_adult = yes
		# Diarchy checks.
		has_diarchy_active_parameter = diarchy_is_vizierate
		NOT = { has_diarchy_active_parameter = vizier_cannot_be_snaked }
		# Anarchy Check
		has_character_modifier = anarchy_at_samarra_financial_straits
	}

	weight_multiplier = {
		base = 1
		
		# Weight up if your diarch is loyal.
		modifier = {
			add = 0.5
			diarch.diarch_loyalty >= diarch_loyalty_visibly_loyal_threshold
		}
		# Weight down if they're disloyal.
		modifier = {
			add = -0.5
			diarch.diarch_loyalty <= diarch_loyalty_visibly_disloyal_threshold
		}
	}

	#Resend
	on_trigger_fail = {
		if = {
			trigger_event = {
				id = AaS_peril.0003
				days = 30 #~1 month
			}
		}
	}

	immediate = {
		## Nab the vizier for ease of loc.
		diarch = { save_scope_as = vizier }
	}

	option = { # Raise taxes
		name = stewardship_wealth.1021.a
		every_sub_realm_county = {
			custom = stewardship_wealth.1021.a.custom
			add_county_modifier = {
				modifier = governance_1021_war_taxes_modifier
				years = 3
			}	
		}

		stress_impact = {
			compassionate = minor_stress_impact_gain
			generous = minor_stress_impact_gain
		}
		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_greed = 2
				ai_compassion = -1
				ai_honor = 2
			}
		}	
	}

	option = {
		name = stewardship_wealth.1011.c

		add_stewardship_lifestyle_xp = medium_lifestyle_experience

		duel = {
			skill = stewardship
			value = 10

			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
				}
				desc = stewardship_wealth.1011.c.success
				send_interface_toast = {
					type = event_toast_effect_good
					title = stewardship_wealth.1011.c.success
					left_icon = root

					#Add silver coins modifier to realm.
					every_sub_realm_county = {
						custom = stewardship_wealth.1011.custom
						add_county_modifier = {
							modifier = governance_newly_minted_silver_coins_modifier
							days = 1825
						}		
					}

					#Adds gold to the character's treasury.
					add_gold = medium_gold_value
				}
			}
			50 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
				}
				desc = stewardship_wealth.1011.c.failure
				send_interface_toast = {
					type = event_toast_effect_bad
					title = stewardship_wealth.1011.c.failure
					left_icon = root
					
					add_prestige = medium_prestige_loss
				}
			}
		}		


		stress_impact = {
			generous = medium_stress_impact_gain
			honest = medium_stress_impact_gain
		}
		ai_chance = {
			base = 50
			ai_value_modifier = {
				ai_greed = 3
				ai_honor = -1
			}
		}			
	}

	option = { # Do nothing
		name = AaS_peril.0003.c

		ai_chance = {
			base = 0
		}
	}
}

scripted_trigger anarchy_peril_0006_disobedient_subject = {
	is_available_adult = yes
	OR = {
		opinion = {
			target = root
			value < 10
		}
		AND = {
			opinion = {
				target = root
				value < 30
			}
			OR = {
				has_trait = ambitious
				has_trait = greedy
				has_trait = wrathful
				has_trait = arrogant
				has_trait = deceitful
				has_trait = paranoid
				has_trait = stubborn
				has_trait = vengeful
			}
		}
	}
	NOT = {
		has_trait = content
	}
	root = {
		NOT = {
			has_hook = prev #Because there's a chance to gain a hook (added in diplomacy_generic_0012_good_outcome_effect)
		}
	}
}

AaS_peril.0006 = { # A prominant commander/council member is demanding better previlages/honors.
	type = character_event
	title = diplomacy_generic.0012.t
	desc = {
		desc = diplomacy_generic.0012.start.desc
		random_valid = {
			triggered_desc = {
				trigger = { scope:disobedient_subject = { is_normal_councillor = yes } }
				desc = diplomacy_generic.0012.council.desc
			}
			triggered_desc = {
				trigger = { scope:disobedient_subject = { is_normal_councillor = no } }
				desc = diplomacy_generic.0012.vassal.desc
			}
		}
		desc = diplomacy_generic.0012.end.desc
	}
	theme = diplomacy
	override_background = {
		trigger = { scope:disobedient_subject = { is_normal_councillor = yes } }
		reference = council_chamber
	}
	left_portrait = scope:disobedient_subject
	
	trigger = {
		NOT = { has_character_flag = had_event_anarchy_peril_0006 }
		OR = {
			any_vassal = {
				diplomacy_generic_0012_disobedient_subject = yes
			}
			any_normal_councillor = {
				diplomacy_generic_0012_disobedient_subject = yes
			}
		}
	}

	immediate = {
		add_character_flag = {
			flag = had_event_anarchy_peril_0006
			days = 1825
		}
		save_scope_as = suppressor
		#Find all potential troublemakers
		every_vassal = {
			limit = { diplomacy_generic_0012_disobedient_subject = yes }
			add_to_temporary_list = disobedient_subject_options
		}
		every_normal_councillor = {
			limit = { diplomacy_generic_0012_disobedient_subject = yes }
			add_to_temporary_list = disobedient_subject_options
		}

		#Pick the troublemaker
		random_in_list = {
			list = disobedient_subject_options
			weight = {
				base = 1
				opinion_modifier = {
					opinion_target = root
					multiplier = -0.3 #Adds 30 for -100 opinion
					min = 1
				}
				modifier = {
					add = 10
					OR = {
						ai_greed >= medium_positive_greed
						ai_rationality <= medium_negative_rationality
						ai_vengefulness >= medium_positive_vengefulness
					}
				}
				modifier = {
					add = 50
					is_powerful_vassal = yes
				}
			}
			save_scope_as = disobedient_subject

			hidden_effect = {
				if = {	
					limit = {
						can_set_relation_potential_rival_trigger = { CHARACTER = root }
					}
					set_relation_potential_rival = root
				}
			}
		}
	}

	#Acquiesce
	option = {
		name = AaS_peril.0006.a
		
		add_dread = medium_dread_loss
		add_prestige = medium_prestige_loss

		scope:disobedient_subject = { add_prestige = medium_prestige_gain }


		stress_impact = {
			forgiving = minor_stress_impact_gain
			shy = minor_stress_impact_gain
			craven = minor_stress_impact_gain
		}
	}

	#Threat of force
	option = {
		name = diplomacy_generic.0012.g
		flavor = threat_option.tt
		diplomacy_generic_0012_tooltip_effect = yes

		save_scope_value_as = { name = technique value = flag:threat }

		stress_impact = {
			forgiving = minor_stress_impact_gain
			shy = minor_stress_impact_gain
			craven = minor_stress_impact_gain
		}
	}

	#Shut up, I'm the king
	option = {
		trigger = { dread >= 35 }
		name = diplomacy_generic.0012.h
		flavor = diplomacy_generic.0012.tt

		stress_impact = {
			calm = minor_stress_impact_gain
			deceitful = minor_stress_impact_gain
			gregarious = minor_stress_impact_gain
			shy = minor_stress_impact_gain
			fickle = minor_stress_impact_gain
			craven = minor_stress_impact_gain
		}
		
		reverse_add_opinion = {
			target = scope:disobedient_subject
			opinion = -5
			modifier = scared_opinion
		}
		add_dread = minor_dread_gain
	}

	after = {

	}
}	